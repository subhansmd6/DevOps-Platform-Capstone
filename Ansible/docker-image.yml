---
- name: Build & Push Docker image (Final Working Version)
  hosts: docker
  become: yes
  vars_files:
    - ../vars/secrets.yml

  tasks:

    # ────────────────────── Ensure Docker Installed ──────────────────────
    - name: Install Docker packages
      apt:
        name: [docker-ce, docker-ce-cli, containerd.io]
        state: present
        update_cache: yes
      ignore_errors: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Reset connection for docker group
      meta: reset_connection



    # ====================================================================
    # STEP 1 — FETCH FILES FROM BUILD SERVER TO CONTROLLER
    # ====================================================================

    - name: Fetch WAR from build-server → controller
      fetch:
        src: /opt/project/Java-code/target/LoginRegistration.war
        dest: /tmp/LoginRegistration.war
        flat: yes
      delegate_to: build-server

    - name: Fetch Dockerfile from build-server → controller
      fetch:
        src: /opt/project/Java-code/Dockerfile
        dest: /tmp/Dockerfile
        flat: yes
      delegate_to: build-server



    # ====================================================================
    # STEP 2 — COPY FILES FROM CONTROLLER → DOCKER SERVER
    # ====================================================================

    - name: Create working directory on docker server
      file:
        path: /opt/project/target
        state: directory
        mode: '0755'

    - name: Copy WAR to docker server
      copy:
        src: /tmp/LoginRegistration.war
        dest: /opt/project/target/LoginRegistration.war

    - name: Copy Dockerfile to docker server
      copy:
        src: /tmp/Dockerfile
        dest: /opt/project/Dockerfile



    # ====================================================================
    # STEP 3 — BUILD & PUSH IMAGE
    # ====================================================================

    - name: Build Docker image
      shell: docker build -t {{ dockerhub_repo }}:latest .
      args:
        chdir: /opt/project

    - name: Docker login
      shell: echo "{{ dockerhub_pass }}" | docker login -u "{{ dockerhub_user }}" --password-stdin
      no_log: true

    - name: Push image to DockerHub
      shell: docker push {{ dockerhub_repo }}:latest


    - name: SUCCESS
      debug:
        msg: "Docker image {{ dockerhub_repo }}:latest built and pushed successfully!"

